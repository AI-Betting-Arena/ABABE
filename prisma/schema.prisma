// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}



// 1. User & Auth: 시스템의 주체
model User {
  id           Int      @id @default(autoincrement())
  provider     String   // "github", "google" 등
  socialId     String   // 소셜 고유 ID
  username     String
  email        String?  @unique
  password     String   @default("")
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([socialId, provider])
  @@map("users")
}

// 2. League: 대회 그 자체 (최상위 부모)
model League {
  id            Int      @id @default(autoincrement())
  apiId         Int      @unique @map("api_id")
  name          String   @db.VarChar(100)
  code          String   @unique @db.VarChar(10) // 예: PL
  type          String?  @db.VarChar(20)
  emblem        String?  @db.Text
  areaName      String?  @map("area_name")
  areaCode      String?  @map("area_code")
  areaFlag      String?  @map("area_flag")
  
  seasons       Season[]

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("leagues")
}

// 3. Season: 특정 연도의 리그 (League의 자식)
model Season {
  id              Int      @id @default(autoincrement())
  apiId           Int      @unique @map("api_id")
  leagueId        Int      @map("league_id")
  league          League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  startDate       DateTime @map("start_date")
  endDate         DateTime @map("end_date")

  // 관계 설정
  seasonTeams     SeasonTeam[] 
  matches         Match[]

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([leagueId, apiId])
  @@map("seasons")
}

// 4. Team: 독립적인 구단 정보
model Team {
  id          Int      @id @default(autoincrement())
  apiId       Int      @unique @map("api_id")
  name        String   @db.VarChar(100)
  shortName   String?  @map("short_name")
  tla         String?  @db.VarChar(10)
  crest       String?  @db.Text
  
  // 관계 설정
  seasonTeams  SeasonTeam[]
  homeMatches  Match[] @relation("HomeMatch")
  awayMatches  Match[] @relation("AwayMatch")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("teams")
}

// 5. SeasonTeam: 시즌과 팀의 다대다 연결 (중간 테이블)
model SeasonTeam {
  id        Int      @id @default(autoincrement())
  seasonId  Int      @map("season_id")
  teamId    Int      @map("team_id")
  
  season    Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([seasonId, teamId])
  @@map("season_teams")
}

// 6. Match: 특정 시즌에 벌어지는 경기 (최종 데이터)
model Match {
  id            Int      @id @default(autoincrement())
  apiId         Int      @unique @map("api_id")
  
  seasonId      Int      @map("season_id")
  season        Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  
  utcDate       DateTime @map("utc_date")
  status        String   @db.VarChar(20)
  matchday      Int      
  stage         String?  @db.VarChar(50)

  homeTeamId    Int      @map("home_team_id")
  homeTeam      Team     @relation("HomeMatch", fields: [homeTeamId], references: [id])
  
  awayTeamId    Int      @map("away_team_id")
  awayTeam      Team     @relation("AwayMatch", fields: [awayTeamId], references: [id])

  winner        String?  @db.VarChar(20)
  homeScore     Int?     @map("home_score")
  awayScore     Int?     @map("away_score")

  // 베팅 풀 (비즈니스 로직)
  poolHome      Decimal  @default(0.00) @map("pool_home") @db.Decimal(15, 2)
  poolDraw      Decimal  @default(0.00) @map("pool_draw") @db.Decimal(15, 2)
  poolAway      Decimal  @default(0.00) @map("pool_away") @db.Decimal(15, 2)

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("matches")
}
