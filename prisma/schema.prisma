// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// 1. User & Auth: 시스템의 주체
model User {
  id           Int      @id @default(autoincrement())
  provider     String   // "github", "google" 등
  socialId     String   // 소셜 고유 ID
  username     String
  email        String?  @unique
  password     String   @default("")
  avatarUrl    String?
  gents  Agent[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([socialId, provider])
  @@map("users")
}

model Agent {
  id              Int      @id @default(autoincrement())
  agentId         String   @unique @map("agent_id") // agent_177...
  secretKey       String   @unique @map("secret_key")
  
  // 1. 기본 프로필 정보
  name            String   @db.VarChar(50)
  description     String?  @db.Text
  badge           String?  @db.VarChar(20) // "Expert", "Beginner" 등
  strategy        String?  @db.Text        // 에이전트의 전략 설명

  balance         Decimal  @default(0.00) @db.Decimal(15, 2) // 에이전트의 가상 자금
  
  // 2. 관계 설정
  userId          Int      @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 에이전트가 생성한 예측(베팅)들
  predictions     Prediction[]

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("agents")
}

model Prediction {
  id          Int      @id @default(autoincrement())
  
  // 관계 설정
  agentId     Int      @map("agent_id")
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  matchId     Int      @map("match_id")
  match       Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  betAmount Decimal  @default(0.00) @map("bet_amount") @db.Decimal(15, 2)
  betOdd    Decimal  @default(0.00) @map("bet_odd")    @db.Decimal(15, 2)

  // 1. 핵심 예측 정보
  prediction  String   // "Manchester City Win" (선택지)
  confidence  Int      // 85 (신뢰도 %)
  summary     String   @db.Text // 요약 문구
  
  // 2. 상세 분석 내용 (Markdown 지원을 위한 Text 타입)
  content     String   @db.Text
  
  // 3. 리스트형 데이터 (PostgreSQL의 String Array 활용)
  keyPoints   String[] @map("key_points")
  
  // 4. 통계 데이터 (JSONB 타입을 사용하면 구조가 복잡한 stats를 한 번에 저장 가능)
  // PostgreSQL의 JSONB는 쿼리 성능도 좋고 유연해서 이런 상황에 딱이야!
  analysisStats Json?    @map("analysis_stats") // { homeWinRate: 83, avgGoals: 3.2 ... }

  // 결과 상태
  status      String   @default("PENDING") // PENDING, SUCCESS, FAIL

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("predictions")
}

// 2. League: 대회 그 자체 (최상위 부모)
model League {
  id            Int      @id @default(autoincrement())
  apiId         Int      @unique @map("api_id")
  name          String   @db.VarChar(100)
  code          String   @unique @db.VarChar(10) // 예: PL
  type          String?  @db.VarChar(20)
  emblem        String?  @db.Text
  areaName      String?  @map("area_name")
  areaCode      String?  @map("area_code")
  areaFlag      String?  @map("area_flag")
  
  seasons       Season[]

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("leagues")
}

// 3. Season: 특정 연도의 리그 (League의 자식)
model Season {
  id              Int      @id @default(autoincrement())
  apiId           Int      @unique @map("api_id")
  leagueId        Int      @map("league_id")
  league          League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  startDate       DateTime @map("start_date")
  endDate         DateTime @map("end_date")

  // 관계 설정
  seasonTeams     SeasonTeam[] 
  matches         Match[]

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([leagueId, apiId])
  @@map("seasons")
}

// 4. Team: 독립적인 구단 정보
model Team {
  id          Int      @id @default(autoincrement())
  apiId       Int      @unique @map("api_id")
  name        String   @db.VarChar(100)
  shortName   String?  @map("short_name")
  tla         String?  @db.VarChar(10)
  crest       String?  @db.Text
  
  // 관계 설정
  seasonTeams  SeasonTeam[]
  homeMatches  Match[] @relation("HomeMatch")
  awayMatches  Match[] @relation("AwayMatch")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("teams")
}

// 5. SeasonTeam: 시즌과 팀의 다대다 연결 (중간 테이블)
model SeasonTeam {
  id        Int      @id @default(autoincrement())
  seasonId  Int      @map("season_id")
  teamId    Int      @map("team_id")
  
  season    Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([seasonId, teamId])
  @@map("season_teams")
}

// 6. Match: 특정 시즌에 벌어지는 경기 (최종 데이터)
model Match {
  id            Int      @id @default(autoincrement())
  apiId         Int      @unique @map("api_id")
  
  seasonId      Int      @map("season_id")
  season        Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  
  utcDate       DateTime @map("utc_date")
  status        MatchStatus
  matchday      Int      
  stage         String?  @db.VarChar(50)

  homeTeamId    Int      @map("home_team_id")
  homeTeam      Team     @relation("HomeMatch", fields: [homeTeamId], references: [id])
  
  awayTeamId    Int      @map("away_team_id")
  awayTeam      Team     @relation("AwayMatch", fields: [awayTeamId], references: [id])

  predictions   Prediction[]

  winner        String?  @db.VarChar(20)
  homeScore     Int?     @map("home_score")
  awayScore     Int?     @map("away_score")

  // 베팅 풀 (비즈니스 로직)
  poolHome      Decimal  @default(0.00) @map("pool_home") @db.Decimal(15, 2)
  poolDraw      Decimal  @default(0.00) @map("pool_draw") @db.Decimal(15, 2)
  poolAway      Decimal  @default(0.00) @map("pool_away") @db.Decimal(15, 2)

  oddsHome      Decimal  @default(0.00) @map("odds_home") @db.Decimal(15, 2)
  oddsDraw      Decimal  @default(0.00) @map("odds_draw") @db.Decimal(15, 2)
  oddsAway      Decimal  @default(0.00) @map("odds_away") @db.Decimal(15, 2)

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("matches")
}

enum MatchStatus {
  UPCOMING
  BETTING_OPEN
  BETTING_CLOSED
  SETTLED
}